<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chama System</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body { font-family: system-ui, sans-serif; }
  .tab { display: none; }
</style>
</head>

<body class="bg-gray-100">

<!-- LOADER -->
<div id="loader" class="fixed inset-0 bg-white bg-opacity-70 flex items-center justify-center hidden z-50">
  <div class="animate-spin h-10 w-10 border-4 border-blue-600 border-t-transparent rounded-full"></div>
</div>

<!-- LOGIN -->
<div id="loginPage" class="flex items-center justify-center h-screen">
  <div class="bg-white p-8 rounded shadow w-full max-w-md">
    <h1 class="text-2xl font-bold mb-4 text-center">Chama Login</h1>
    <input id="phone" placeholder="Phone" class="border p-2 w-full mb-3 rounded">
    <input id="password" type="password" placeholder="Password" class="border p-2 w-full mb-3 rounded">
    <button onclick="login()" class="bg-blue-600 text-white px-4 py-2 rounded w-full">Login</button>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboardPage" class="hidden max-w-7xl mx-auto p-4 space-y-4">

  <div class="flex justify-between items-center">
    <h1 class="text-2xl font-bold">Chama Dashboard</h1>
    <button onclick="logout()" class="text-red-600 font-semibold">Logout</button>
  </div>

  <p>Logged in as: <b id="userRole"></b></p>

  <!-- NAV -->
  <div class="flex gap-2 bg-white p-2 rounded shadow overflow-x-auto">
    <button onclick="showTab('overview')" class="px-4 py-2 bg-blue-600 text-white rounded">Overview</button>
    <button onclick="showTab('statement')" class="px-4 py-2 bg-gray-200 rounded">Statement</button>
    <button id="adminBtn" onclick="showTab('admin')" class="px-4 py-2 bg-gray-200 rounded hidden">Admin</button>
  </div>

  <!-- OVERVIEW -->
  <div id="overview" class="tab block space-y-4">
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
      <div class="bg-white p-4 rounded shadow text-center">
        <p class="text-gray-500">Members</p>
        <p id="totalMembers" class="text-2xl font-bold">0</p>
      </div>
      <div class="bg-white p-4 rounded shadow text-center">
        <p class="text-gray-500">Contributions</p>
        <p id="totalContrib" class="text-2xl font-bold">0</p>
      </div>
      <div class="bg-white p-4 rounded shadow text-center">
        <p class="text-gray-500">Loans</p>
        <p id="totalLoans" class="text-2xl font-bold">0</p>
      </div>
      <div class="bg-white p-4 rounded shadow text-center">
        <p class="text-gray-500">Balance</p>
        <p id="totalBalance" class="text-2xl font-bold">0</p>
      </div>
      <div class="bg-white p-4 rounded shadow text-center">
        <p class="text-gray-500">Overdue</p>
        <p id="overdueLoans" class="text-2xl font-bold text-red-600">0</p>
      </div>
    </div>

    <div class="bg-white p-4 rounded shadow">
      <canvas id="financeChart"></canvas>
    </div>
  </div>

  <!-- STATEMENT -->
  <div id="statement" class="tab space-y-4">
    <div class="bg-white p-4 rounded shadow">
      <select id="memberSelect" class="border p-2 rounded w-full mb-3"></select>

      <table class="w-full border text-sm">
        <thead class="bg-gray-200">
          <tr>
            <th class="border p-2">Date</th>
            <th class="border p-2">Type</th>
            <th class="border p-2">Amount</th>
            <th class="border p-2">Status</th>
          </tr>
        </thead>
        <tbody id="statementBody"></tbody>
      </table>

      <div class="mt-3 font-bold space-y-1">
        <p>Contributions: <span id="statementContrib">0</span></p>
        <p>Loans: <span id="statementLoans">0</span></p>
        <p>Balance: <span id="statementBalance">0</span></p>
      </div>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="admin" class="tab space-y-4">

    <div class="grid md:grid-cols-3 gap-4">
      <div class="bg-white p-4 rounded shadow">
        <h2 class="font-bold mb-2">Add Member</h2>
        <input id="newMemberName" placeholder="Name" class="border p-2 w-full mb-2">
        <input id="newMemberPhone" placeholder="Phone" class="border p-2 w-full mb-2">
        <button onclick="addMember()" class="bg-green-600 text-white px-4 py-2 rounded w-full">Add</button>
      </div>

      <div class="bg-white p-4 rounded shadow">
        <h2 class="font-bold mb-2">Add Contribution</h2>
        <select id="contribMemberSelect" class="border p-2 w-full mb-2"></select>
        <input id="contribAmount" type="number" placeholder="Amount" class="border p-2 w-full mb-2">
        <button onclick="addContribution()" class="bg-blue-600 text-white px-4 py-2 rounded w-full">Add</button>
      </div>

      <div class="bg-white p-4 rounded shadow">
        <h2 class="font-bold mb-2">Add Loan</h2>
        <select id="loanMemberSelect" class="border p-2 w-full mb-2"></select>
        <input id="loanAmount" type="number" placeholder="Amount" class="border p-2 w-full mb-2">
        <button onclick="addLoan()" class="bg-red-600 text-white px-4 py-2 rounded w-full">Add</button>
      </div>
    </div>

  </div>

</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyo-V7DxUQr1XW0ETtIF-NNYhm8dHItT0YfU9KwyPIK3zbMB_BVg0hegCmYapqQi_CWCA/exec";

// ---------- SESSION ----------
const session = {
  save:d=>localStorage.setItem("chamaSession",JSON.stringify(d)),
  get:()=>JSON.parse(localStorage.getItem("chamaSession")),
  clear:()=>localStorage.removeItem("chamaSession")
};

let role=null, phone=null;
let members=[], contributions=[], loans=[];
let chart=null;

// ---------- HELPERS ----------
const money = n => Number(n).toLocaleString("en-KE",{style:"currency",currency:"KES"});
const showLoader = ()=>loader.classList.remove("hidden");
const hideLoader = ()=>loader.classList.add("hidden");

function post(action,data={}) {
  return fetch(API,{method:"POST",body:JSON.stringify({action,...data})})
    .then(r=>r.json());
}

// ---------- LOGIN ----------
function login(){
  showLoader();
  post("login",{phone:phone.value,password:password.value})
  .then(d=>{
    if(!d.success) return alert("Invalid login");
    role=d.role; phone=phone.value;
    session.save({role,phone});
    init();
  }).finally(hideLoader);
}

function logout(){
  session.clear();
  location.reload();
}

// ---------- INIT ----------
function init(){
  loginPage.classList.add("hidden");
  dashboardPage.classList.remove("hidden");
  userRole.textContent = role.toUpperCase();
  if(role==="admin") adminBtn.classList.remove("hidden");
  loadData();
}

// ---------- DATA ----------
function loadData(){
  showLoader();
  Promise.all([
    post("getMembers"),
    post("getContributions"),
    post("getLoans")
  ]).then(([m,c,l])=>{
    members=m.slice(1);
    contributions=c.slice(1);
    loans=l.slice(1);
    render();
  }).finally(hideLoader);
}

// ---------- RENDER ----------
function render(){
  const visible = role==="admin"?members:members.filter(m=>m[2]===phone);
  const tc = contributions.filter(c=>visible.some(m=>m[0]==c[1])).reduce((s,c)=>s+Number(c[2]),0);
  const tl = loans.filter(l=>visible.some(m=>m[0]==l[1])).reduce((s,l)=>s+Number(l[2]),0);

  totalMembers.textContent = visible.length;
  totalContrib.textContent = money(tc);
  totalLoans.textContent = money(tl);
  totalBalance.textContent = money(tc-tl);
  overdueLoans.textContent = loans.filter(l=>new Date()-new Date(l[4])>30*86400000).length;

  renderChart(tc,tl);
  renderStatementSelect();
  populateAdminSelects();
}

// ---------- CHART ----------
function renderChart(c,l){
  if(chart) chart.destroy();
  chart = new Chart(financeChart,{
    type:"bar",
    data:{
      labels:["Contributions","Loans","Balance"],
      datasets:[{data:[c,l,c-l]}]
    }
  });
}

// ---------- STATEMENT ----------
function renderStatementSelect(){
  memberSelect.innerHTML="";
  const list = role==="admin"?members:members.filter(m=>m[2]===phone);
  list.forEach(m=>{
    const o=document.createElement("option");
    o.value=m[0]; o.textContent=m[1];
    memberSelect.appendChild(o);
  });
  showStatement();
}

function showStatement(){
  post("memberStatement",{memberId:memberSelect.value}).then(d=>{
    statementBody.innerHTML="";
    d.contributions.forEach(r=>{
      statementBody.innerHTML+=`<tr>
        <td class="border p-2">${new Date(r.date).toLocaleDateString()}</td>
        <td class="border p-2">Contribution</td>
        <td class="border p-2">${money(r.amount)}</td>
        <td class="border p-2">-</td></tr>`;
    });
    d.loans.forEach(r=>{
      statementBody.innerHTML+=`<tr>
        <td class="border p-2">${new Date(r.date).toLocaleDateString()}</td>
        <td class="border p-2">Loan</td>
        <td class="border p-2">${money(r.amount)}</td>
        <td class="border p-2 ${r.overdue?'text-red-600 font-bold':''}">${r.status}</td></tr>`;
    });
    statementContrib.textContent=money(d.totalContributions);
    statementLoans.textContent=money(d.totalLoans);
    statementBalance.textContent=money(d.balance);
  });
}

// ---------- ADMIN ----------
function populateAdminSelects(){
  if(role!=="admin") return;
  [contribMemberSelect,loanMemberSelect].forEach(s=>{
    s.innerHTML="";
    members.forEach(m=>{
      const o=document.createElement("option");
      o.value=m[0]; o.textContent=m[1];
      s.appendChild(o);
    });
  });
}

function addMember(){ post("addMember",{name:newMemberName.value,phone:newMemberPhone.value}).then(loadData); }
function addContribution(){ post("addContribution",{memberId:contribMemberSelect.value,amount:contribAmount.value}).then(loadData); }
function addLoan(){ post("addLoan",{memberId:loanMemberSelect.value,amount:loanAmount.value}).then(loadData); }

// ---------- TABS ----------
function showTab(id){
  document.querySelectorAll(".tab").forEach(t=>t.style.display="none");
  document.getElementById(id).style.display="block";
}

// ---------- AUTO LOGIN ----------
window.onload = ()=>{
  const s=session.get();
  if(s){ role=s.role; phone=s.phone; init(); }
};

// ---------- PWA ----------
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
