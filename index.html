<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<title>Chama System</title>
</head>

<body class="bg-gray-100">

<div id="login" class="h-screen flex items-center justify-center">
  <div class="bg-white p-6 rounded w-80">
    <h2 class="font-bold text-xl mb-3">Login</h2>
    <input id="phone" class="border p-2 w-full mb-2" placeholder="Phone">
    <input id="password" type="password" class="border p-2 w-full mb-2" placeholder="Password">
    <select id="chama" class="border p-2 w-full mb-2"></select>
    <button onclick="login()" class="bg-blue-600 text-white w-full p-2 rounded">Login</button>
  </div>
</div>

<div id="app" class="hidden p-4">
  <h1 class="font-bold text-xl mb-3">Dashboard</h1>

  <div id="admin" class="hidden">
    <p>Total Members: <b id="m"></b></p>
    <p>Contributions: <b id="c"></b></p>
    <p>Loans: <b id="l"></b></p>
    <p>Balance: <b id="b"></b></p>
  </div>

  <div id="member" class="hidden">
    <h2 class="font-bold">My Loans</h2>
    <table class="w-full text-sm border">
      <tbody id="loans"></tbody>
    </table>

    <h2 class="font-bold mt-4">Apply Loan</h2>
    <input id="loanAmt" class="border p-2 w-full">
    <button onclick="applyLoan()" class="bg-green-600 text-white p-2 w-full mt-2">Apply</button>
  </div>

  <button onclick="logout()" class="text-red-600 mt-4">Logout</button>
</div>

<script>
const API="PASTE_YOUR_DEPLOYED_URL_HERE";
let role,userId,chamaId;

function post(action,data){
  return fetch(API,{method:"POST",body:JSON.stringify({action,...data})})
    .then(r=>r.json());
}

function login(){
  post("login",{
    phone:phone.value,
    password:password.value,
    chamaId:chama.value
  }).then(d=>{
    if(!d.success) return alert(d.message);
    role=d.role; userId=d.userId; chamaId=d.chamaId;
    login.style.display="none";
    app.classList.remove("hidden");
    role==="admin"?loadAdmin():loadMember();
  });
}

function loadAdmin(){
  admin.classList.remove("hidden");
  post("getDashboard",{chamaId}).then(d=>{
    m.textContent=d.members;
    c.textContent=d.totalContrib;
    l.textContent=d.totalLoans;
    b.textContent=d.balance;
  });
}

function loadMember(){
  member.classList.remove("hidden");
  post("getMemberData",{memberId:userId,chamaId}).then(d=>{
    loans.innerHTML="";
    d.loans.forEach(x=>{
      loans.innerHTML+=`<tr><td>${x[4]}</td><td>${x[5]}</td></tr>`;
    });
  });
}

function applyLoan(){
  post("applyLoan",{memberId:userId,amount:loanAmt.value,chamaId})
    .then(()=>alert("Loan submitted"));
}

function logout(){ location.reload(); }

post("getChamas").then(d=>{
  chama.innerHTML=d.map(x=>`<option value="${x.id}">${x.name}</option>`).join("");
});
</script>
</body>
</html>
