<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chama System</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: sans-serif; }
</style>
</head>
<body class="bg-gray-100">

<!-- LOGIN -->
<div id="loginPage" class="flex items-center justify-center h-screen">
  <div class="bg-white p-8 rounded shadow w-full max-w-md">
    <h1 class="text-2xl font-bold mb-4 text-center">Chama Login</h1>
    <div class="mb-2">
      <input id="phone" placeholder="Phone" class="border p-2 w-full rounded">
      <p id="phoneError" class="text-red-600 text-sm hidden">Phone is required</p>
    </div>
    <div class="mb-2">
      <input id="password" type="password" placeholder="Password" class="border p-2 w-full rounded">
      <p id="passwordError" class="text-red-600 text-sm hidden">Password is required</p>
    </div>
    <p id="loginError" class="text-red-600 text-center mb-3 hidden"></p>
    <button onclick="login()" class="bg-blue-600 text-white px-4 py-2 rounded w-full">Login</button>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboardPage" class="hidden p-4 max-w-7xl mx-auto space-y-6">
  <h1 class="text-3xl font-bold">Chama Dashboard</h1>
  <p>Logged in as: <span id="userRole"></span></p>

  <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
    <div class="bg-white p-4 rounded shadow text-center">
      <p class="text-gray-500">Members</p>
      <p id="totalMembers" class="text-2xl font-bold">0</p>
    </div>
    <div class="bg-white p-4 rounded shadow text-center">
      <p class="text-gray-500">Total Contributions</p>
      <p id="totalContrib" class="text-2xl font-bold">0</p>
    </div>
    <div class="bg-white p-4 rounded shadow text-center">
      <p class="text-gray-500">Total Loans</p>
      <p id="totalLoans" class="text-2xl font-bold">0</p>
    </div>
    <div class="bg-white p-4 rounded shadow text-center">
      <p class="text-gray-500">Balance</p>
      <p id="totalBalance" class="text-2xl font-bold">0</p>
    </div>
    <div class="bg-white p-4 rounded shadow text-center">
      <p class="text-gray-500">Overdue Loans</p>
      <p id="overdueLoans" class="text-2xl font-bold text-red-600">0</p>
    </div>
  </div>

  <!-- ADMIN PANEL -->
  <div id="adminPanel" class="grid grid-cols-1 md:grid-cols-3 gap-4 hidden mt-4">
    <div class="bg-white p-4 rounded shadow">
      <h2 class="font-semibold mb-2">Add Member</h2>
      <input id="newMemberName" placeholder="Name" class="border p-2 rounded w-full mb-2">
      <input id="newMemberPhone" placeholder="Phone" class="border p-2 rounded w-full mb-2">
      <button onclick="addMember()" class="bg-green-600 text-white px-4 py-2 rounded w-full">Add Member</button>
    </div>
    <div class="bg-white p-4 rounded shadow">
      <h2 class="font-semibold mb-2">Add Contribution</h2>
      <select id="contribMemberSelect" class="border p-2 rounded w-full mb-2"></select>
      <input id="contribAmount" type="number" placeholder="Amount" class="border p-2 rounded w-full mb-2">
      <button onclick="addContribution()" class="bg-blue-600 text-white px-4 py-2 rounded w-full">Add Contribution</button>
    </div>
    <div class="bg-white p-4 rounded shadow">
      <h2 class="font-semibold mb-2">Add Loan</h2>
      <select id="loanMemberSelect" class="border p-2 rounded w-full mb-2"></select>
      <input id="loanAmount" type="number" placeholder="Amount" class="border p-2 rounded w-full mb-2">
      <button onclick="addLoan()" class="bg-red-600 text-white px-4 py-2 rounded w-full">Add Loan</button>
    </div>
  </div>

  <!-- CHARTS -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
    <div class="bg-white p-4 rounded shadow">
      <h2 class="font-semibold mb-2">Contributions</h2>
      <canvas id="contribChart"></canvas>
    </div>
    <div class="bg-white p-4 rounded shadow">
      <h2 class="font-semibold mb-2">Loans</h2>
      <canvas id="loanChart"></canvas>
    </div>
  </div>

  <!-- MEMBER STATEMENT -->
  <div class="bg-white p-4 rounded shadow mt-4">
    <h2 class="text-xl font-semibold mb-3">Member Statement</h2>
    <select id="memberSelect" class="border p-2 rounded mb-3 w-full md:w-1/3"></select>
    <table class="w-full table-auto border-collapse border mb-3">
      <thead class="bg-gray-200">
        <tr><th class="border p-2">Date</th><th class="border p-2">Type</th><th class="border p-2">Amount</th><th class="border p-2">Status</th></tr>
      </thead>
      <tbody id="statementBody"></tbody>
    </table>
    <p class="font-bold">Total Contributions: <span id="statementContrib">0</span></p>
    <p class="font-bold">Total Loans: <span id="statementLoans">0</span></p>
    <p class="font-bold">Balance: <span id="statementBalance">0</span></p>
    <button onclick="downloadPDF()" class="mt-3 bg-gray-800 text-white px-4 py-2 rounded">Download PDF Statement</button>
  </div>
</div>

<script>
const API = "YOUR_APP_SCRIPT_URL"; // replace with your Apps Script URL
let currentUserRole=null, loggedInPhone=null, members=[], contributions=[], loans=[];

// ===== LOGIN =====
function login(){
  const phoneInput = document.getElementById("phone");
  const passwordInput = document.getElementById("password");
  const phoneError = document.getElementById("phoneError");
  const passwordError = document.getElementById("passwordError");
  const loginError = document.getElementById("loginError");

  phoneError.classList.add("hidden");
  passwordError.classList.add("hidden");
  loginError.classList.add("hidden");

  if(!phoneInput.value.trim()){ phoneError.classList.remove("hidden"); return; }
  if(!passwordInput.value.trim()){ passwordError.classList.remove("hidden"); return; }

  fetch(API, { method:"POST", body:JSON.stringify({ action:"login", phone: phoneInput.value, password: passwordInput.value }) })
    .then(r=>r.json())
    .then(data=>{
      if(data.success){
        currentUserRole=data.role;
        loggedInPhone=phoneInput.value;
        document.getElementById("userRole").textContent=currentUserRole.toUpperCase();
        document.getElementById("loginPage").classList.add("hidden");
        document.getElementById("dashboardPage").classList.remove("hidden");
        if(currentUserRole==="admin") document.getElementById("adminPanel").classList.remove("hidden");
        loadData();
      } else {
        loginError.textContent = "Login failed: " + data.message;
        loginError.classList.remove("hidden");
      }
    });
}

// ===== LOAD DATA =====
function loadData(){
  Promise.all([post("getMembers"), post("getContributions"), post("getLoans")])
  .then(([m,c,l])=>{
    members=m.slice(1); contributions=c.slice(1); loans=l.slice(1);
    renderDashboard(); renderCharts(); renderMemberSelect(); populateAdminSelects();
  });
}

function post(action){ return fetch(API, { method:"POST", body:JSON.stringify({ action }) }).then(r=>r.json()); }

// ===== DASHBOARD =====
function renderDashboard(){
  const visibleMembers=currentUserRole==="admin"?members:members.filter(m=>m[2]===loggedInPhone);
  document.getElementById("totalMembers").textContent=visibleMembers.length;
  const totalContrib = contributions.filter(c=>visibleMembers.some(m=>m[0]==c[1])).reduce((s,c)=>s+Number(c[2]),0);
  const totalLoans = loans.filter(l=>visibleMembers.some(m=>m[0]==l[1])).reduce((s,l)=>s+Number(l[2]),0);
  const balance = totalContrib - totalLoans;
  const overdueCount = loans.filter(l=>visibleMembers.some(m=>m[0]==l[1]) && (new Date()-new Date(l[4]))/(1000*60*60*24)>30).length;
  document.getElementById("totalContrib").textContent=totalContrib;
  document.getElementById("totalLoans").textContent=totalLoans;
  document.getElementById("totalBalance").textContent=balance;
  document.getElementById("overdueLoans").textContent=overdueCount;
}

// ===== ADMIN ACTIONS =====
function populateAdminSelects(){
  if(currentUserRole!=="admin") return;
  const contribSel=document.getElementById("contribMemberSelect");
  const loanSel=document.getElementById("loanMemberSelect");
  contribSel.innerHTML=""; loanSel.innerHTML="";
  members.forEach(m=>{
    const opt1=document.createElement("option"); opt1.value=m[0]; opt1.textContent=m[1]; contribSel.appendChild(opt1);
    const opt2=document.createElement("option"); opt2.value=m[0]; opt2.textContent=m[1]; loanSel.appendChild(opt2);
  });
}

function addMember(){
  const name=document.getElementById("newMemberName").value;
  const phone=document.getElementById("newMemberPhone").value;
  if(!name||!phone){alert("Enter name and phone"); return;}
  fetch(API,{method:"POST",body:JSON.stringify({action:"addMember",name,phone})}).then(r=>r.json()).then(d=>{if(d.success){alert("Member added"); loadData();}});
}

function addContribution(){
  const memberId=document.getElementById("contribMemberSelect").value;
  const amount=document.getElementById("contribAmount").value;
  if(!memberId||!amount){alert("Select member & enter amount"); return;}
  fetch(API,{method:"POST",body:JSON.stringify({action:"addContribution",memberId,amount})}).then(r=>r.json()).then(d=>{if(d.success){alert("Contribution added"); loadData();}});
}

function addLoan(){
  const memberId=document.getElementById("loanMemberSelect").value;
  const amount=document.getElementById("loanAmount").value;
  if(!memberId||!amount){alert("Select member & enter amount"); return;}
  fetch(API,{method:"POST",body:JSON.stringify({action:"addLoan",memberId,amount})}).then(r=>r.json()).then(d=>{if(d.success){alert("Loan added"); loadData();}});
}

function renderMemberSelect(){
  const sel=document.getElementById("memberSelect"); sel.innerHTML="";
  const visibleMembers=currentUserRole==="admin"?members:members.filter(m=>m[2]===loggedInPhone);
  visibleMembers.forEach(m=>{ const opt=document.createElement("option"); opt.value=m[0]; opt.textContent=m[1]; sel.appendChild(opt); });
  sel.onchange=showStatement; if(sel.options.length>0) sel.selectedIndex=0; showStatement();
}

function showStatement(){
  const memberId=document.getElementById("memberSelect").value; if(!memberId) return;
  fetch(API,{method:"POST",body:JSON.stringify({action:"memberStatement",memberId})}).then(r=>r.json()).then(d=>{
    if(!d.success) return;
    const tbody=document.getElementById("statementBody"); tbody.innerHTML="";
    d.contributions.forEach(c=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td class="border p-2">${new Date(c.date).toLocaleDateString()}</td><td class="border p-2">Contribution</td><td class="border p-2">${c.amount}</td><td class="border p-2">-</td>`;
      tbody.appendChild(tr);
    });
    d.loans.forEach(l=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td class="border p-2">${new Date(l.date).toLocaleDateString()}</td><td class="border p-2">Loan</td><td class="border p-2">${l.amount}</td><td class="border p-2 ${l.overdue?'text-red-600 font-bold':''}">${l.status}${l.overdue?' (Overdue)':''}</td>`;
      tbody.appendChild(tr);
    });
    document.getElementById("statementContrib").textContent=d.totalContributions;
    document.getElementById("statementLoans").textContent=d.totalLoans;
    document.getElementById("statementBalance").textContent=d.balance;
  });
}

function renderCharts(){
  const labels=members.map(m=>m[1]);
  const contribData=members.map(m=>contributions.filter(c=>c[1]==m[0]).reduce((s,c)=>s+Number(c[2]),0));
  const loanData=members.map(m=>loans.filter(l=>l[1]==m[0]).reduce((s,l)=>s+Number(l[2]),0));
  new Chart(document.getElementById("contribChart"),{type:"bar",data:{labels,datasets:[{label:"Contributions",data:contribData,backgroundColor:"#3b82f6"}]}});
  new Chart(document.getElementById("loanChart"),{type:"pie",data:{labels,datasets:[{label:"Loans",data:loanData,backgroundColor:["#ef4444","#facc15","#10b981","#3b82f6"]}]}});  
}

function downloadPDF(){
  const memberId=document.getElementById("memberSelect").value;
  if(!memberId){alert("Select a member"); return;}
  window.open(API+"?action=memberStatement&memberId="+memberId,"_blank");
}
</script>

</body>
</html>
