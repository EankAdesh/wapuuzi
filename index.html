<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chama System</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">

<!-- LOGIN -->
<div id="loginPage" class="flex items-center justify-center h-screen">
  <div class="bg-white p-8 rounded shadow w-full max-w-md">
    <h1 class="text-2xl font-bold mb-4 text-center">Chama Login</h1>
    <input id="phone" placeholder="Phone" class="border p-2 w-full mb-3 rounded">
    <input id="password" type="password" placeholder="Password" class="border p-2 w-full mb-3 rounded">
    <button onclick="login()" class="bg-blue-600 text-white px-4 py-2 rounded w-full">Login</button>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboardPage" class="hidden p-4 max-w-7xl mx-auto space-y-6">
  <h1 class="text-3xl font-bold">Chama Dashboard</h1>
  <p>Logged in as: <span id="userRole"></span></p>

  <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
    <div class="bg-white p-4 rounded shadow text-center"><p class="text-gray-500">Members</p><p id="totalMembers" class="text-2xl font-bold">0</p></div>
    <div class="bg-white p-4 rounded shadow text-center"><p class="text-gray-500">Total Contributions</p><p id="totalContrib" class="text-2xl font-bold">0</p></div>
    <div class="bg-white p-4 rounded shadow text-center"><p class="text-gray-500">Total Loans</p><p id="totalLoans" class="text-2xl font-bold">0</p></div>
    <div class="bg-white p-4 rounded shadow text-center"><p class="text-gray-500">Balance</p><p id="totalBalance" class="text-2xl font-bold">0</p></div>
    <div class="bg-white p-4 rounded shadow text-center"><p class="text-gray-500">Overdue Loans</p><p id="overdueLoans" class="text-2xl font-bold text-red-600">0</p></div>
  </div>

  <!-- ADMIN PANEL -->
  <div id="adminPanel" class="grid grid-cols-1 md:grid-cols-3 gap-4 hidden mt-4">
    <div class="bg-white p-4 rounded shadow">
      <h2 class="font-semibold mb-2">Add Member</h2>
      <input id="newMemberName" placeholder="Name" class="border p-2 rounded w-full mb-2">
      <input id="newMemberPhone" placeholder="Phone" class="border p-2 rounded w-full mb-2">
      <button onclick="addMember()" class="bg-green-600 text-white px-4 py-2 rounded w-full">Add Member</button>
    </div>
    <div class="bg-white p-4 rounded shadow">
      <h2 class="font-semibold mb-2">Add Contribution</h2>
      <select id="contribMemberSelect" class="border p-2 rounded w-full mb-2"></select>
      <input id="contribAmount" type="number" placeholder="Amount" class="border p-2 rounded w-full mb-2">
      <button onclick="addContribution()" class="bg-blue-600 text-white px-4 py-2 rounded w-full">Add Contribution</button>
    </div>
    <div class="bg-white p-4 rounded shadow">
      <h2 class="font-semibold mb-2">Add Loan</h2>
      <select id="loanMemberSelect" class="border p-2 rounded w-full mb-2"></select>
      <input id="loanAmount" type="number" placeholder="Amount" class="border p-2 rounded w-full mb-2">
      <button onclick="addLoan()" class="bg-red-600 text-white px-4 py-2 rounded w-full">Add Loan</button>
    </div>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyo-V7DxUQr1XW0ETtIF-NNYhm8dHItT0YfU9KwyPIK3zbMB_BVg0hegCmYapqQi_CWCA/exec"; // Replace with your Apps Script URL
let currentUserRole=null, loggedInPhone=null, members=[], contributions=[], loans=[];

// ===== LOGIN =====
function login(){
  const phone=document.getElementById("phone").value;
  const password=document.getElementById("password").value;
  fetch(API, {method:"POST", body:JSON.stringify({action:"login", phone, password})})
    .then(r=>r.json()).then(data=>{
      if(data.success){
        currentUserRole=data.role;
        document.getElementById("userRole").textContent=currentUserRole.toUpperCase();
        document.getElementById("loginPage").classList.add("hidden");
        document.getElementById("dashboardPage").classList.remove("hidden");
        if(currentUserRole==="admin") document.getElementById("adminPanel").classList.remove("hidden");
        loadData();
      } else alert("Login failed: "+data.message);
    });
}

// ===== LOAD DATA =====
function loadData(){
  Promise.all([post("getMembers"), post("getContributions"), post("getLoans")])
    .then(([m,c,l])=>{
      members=m.slice(1); contributions=c.slice(1); loans=l.slice(1);
      populateAdminSelects(); renderDashboard();
    });
}

function post(action){ return fetch(API, {method:"POST", body:JSON.stringify({action})}).then(r=>r.json()); }

// ===== ADMIN ACTIONS =====
function populateAdminSelects(){
  const contribSel=document.getElementById("contribMemberSelect");
  const loanSel=document.getElementById("loanMemberSelect");
  contribSel.innerHTML=""; loanSel.innerHTML="";
  members.forEach(m=>{
    const opt1=document.createElement("option"); opt1.value=m[0]; opt1.textContent=m[1]; contribSel.appendChild(opt1);
    const opt2=document.createElement("option"); opt2.value=m[0]; opt2.textContent=m[1]; loanSel.appendChild(opt2);
  });
}

function addMember(){
  const name=document.getElementById("newMemberName").value;
  const phone=document.getElementById("newMemberPhone").value;
  if(!name||!phone){ alert("Enter name and phone"); return; }
  fetch(API, {method:"POST", body:JSON.stringify({action:"addMember", name, phone})})
    .then(r=>r.json()).then(data=>{if(data.success){alert("Member added"); loadData();}});
}

function addContribution(){
  const memberId=document.getElementById("contribMemberSelect").value;
  const amount=document.getElementById("contribAmount").value;
  if(!memberId||!amount){alert("Select member and enter amount"); return;}
  fetch(API, {method:"POST", body:JSON.stringify({action:"addContribution", memberId, amount})})
    .then(r=>r.json()).then(data=>{if(data.success){alert("Contribution added"); loadData();}});
}

function addLoan(){
  const memberId=document.getElementById("loanMemberSelect").value;
  const amount=document.getElementById("loanAmount").value;
  if(!memberId||!amount){alert("Select member and enter amount"); return;}
  fetch(API, {method:"POST", body:JSON.stringify({action:"addLoan", memberId, amount})})
    .then(r=>r.json()).then(data=>{if(data.success){alert("Loan added"); loadData();}});
}

// ===== DASHBOARD RENDER =====
function renderDashboard(){
  document.getElementById("totalMembers").textContent=members.length;
  const totalContrib = contributions.reduce((s,c)=>s+Number(c[2]),0);
  const totalLoans = loans.reduce((s,l)=>s+Number(l[2]),0);
  const balance = totalContrib-totalLoans;
  const overdueCount = loans.filter(l=>((new Date()-new Date(l[4]))/(1000*60*60*24))>30).length;
  document.getElementById("totalContrib").textContent=totalContrib;
  document.getElementById("totalLoans").textContent=totalLoans;
  document.getElementById("totalBalance").textContent=balance;
  document.getElementById("overdueLoans").textContent=overdueCount;
}
</script>
</body>
</html>
