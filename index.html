<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Chama System</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">

<!-- LOGIN PAGE -->
<div id="loginPage" class="flex items-center justify-center h-screen">
  <div class="bg-white p-8 rounded shadow w-full max-w-md">
    <h1 class="text-2xl font-bold mb-4 text-center">Chama Login</h1>
    <input id="phone" placeholder="Phone" class="border p-2 w-full mb-3 rounded">
    <input id="password" type="password" placeholder="Password" class="border p-2 w-full mb-3 rounded">
    <button onclick="login()" class="bg-blue-600 text-white px-4 py-2 rounded w-full">Login</button>
  </div>
</div>

<!-- DASHBOARD PAGE -->
<div id="dashboardPage" class="hidden p-4 max-w-7xl mx-auto space-y-6">

<h1 class="text-3xl font-bold">Chama Dashboard</h1>
<p>Logged in as: <span id="userRole"></span></p>

<!-- STATS -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
  <div class="bg-white p-4 rounded shadow">
    <p class="text-gray-500">Members</p>
    <p id="totalMembers" class="text-2xl font-bold">0</p>
  </div>
  <div class="bg-white p-4 rounded shadow">
    <p class="text-gray-500">Total Contributions</p>
    <p id="totalContrib" class="text-2xl font-bold">0</p>
  </div>
  <div class="bg-white p-4 rounded shadow">
    <p class="text-gray-500">Total Loans</p>
    <p id="totalLoans" class="text-2xl font-bold">0</p>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" class="grid grid-cols-1 md:grid-cols-3 gap-4 hidden">
  <div class="bg-white p-4 rounded shadow">
    <h2 class="font-semibold mb-2">Add Member</h2>
    <input id="newMemberName" placeholder="Name" class="border p-2 rounded w-full mb-2">
    <input id="newMemberPhone" placeholder="Phone" class="border p-2 rounded w-full mb-2">
    <button onclick="addMember()" class="bg-green-600 text-white px-4 py-2 rounded w-full">Add Member</button>
  </div>

  <div class="bg-white p-4 rounded shadow">
    <h2 class="font-semibold mb-2">Add Contribution</h2>
    <select id="contribMemberSelect" class="border p-2 rounded w-full mb-2"></select>
    <input id="contribAmount" type="number" placeholder="Amount" class="border p-2 rounded w-full mb-2">
    <button onclick="addContribution()" class="bg-blue-600 text-white px-4 py-2 rounded w-full">Add Contribution</button>
  </div>

  <div class="bg-white p-4 rounded shadow">
    <h2 class="font-semibold mb-2">Add Loan</h2>
    <select id="loanMemberSelect" class="border p-2 rounded w-full mb-2"></select>
    <input id="loanAmount" type="number" placeholder="Amount" class="border p-2 rounded w-full mb-2">
    <button onclick="addLoan()" class="bg-red-600 text-white px-4 py-2 rounded w-full">Add Loan</button>
  </div>
</div>

<!-- CHARTS -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <div class="bg-white p-4 rounded shadow">
    <h2 class="font-semibold mb-2">Contributions</h2>
    <canvas id="contribChart"></canvas>
  </div>
  <div class="bg-white p-4 rounded shadow">
    <h2 class="font-semibold mb-2">Loans</h2>
    <canvas id="loanChart"></canvas>
  </div>
</div>

<!-- MEMBER STATEMENT -->
<div class="bg-white p-4 rounded shadow">
  <h2 class="text-xl font-semibold mb-3">Member Statement</h2>
  <select id="memberSelect" class="border p-2 rounded mb-3 w-full md:w-1/3"></select>
  <pre id="statement" class="bg-gray-100 p-3 rounded text-sm overflow-auto"></pre>
  <button onclick="downloadPDF()" class="mt-3 bg-gray-800 text-white px-4 py-2 rounded">Download PDF Statement</button>
</div>

</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbzGwFYIScrIzIly9vC33S2Xi6MJX843bWa7TobZct0E9jWdMyCyAMY10ypDlFCv8Oky/exec"; // <-- Replace with your Apps Script URL
let currentUserRole=null, loggedInPhone=null, members=[], contributions=[], loans=[];

// ===== LOGIN =====
function login(){
  const phone=document.getElementById("phone").value;
  const password=document.getElementById("password").value;
  fetch(API+"?action=login",{method:"POST", body:JSON.stringify({phone,password})})
  .then(r=>r.json()).then(data=>{
    if(data.success){
      currentUserRole=data.role; loggedInPhone=phone;
      document.getElementById("userRole").textContent=currentUserRole.toUpperCase();
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("dashboardPage").classList.remove("hidden");
      if(currentUserRole==="admin") document.getElementById("adminPanel").classList.remove("hidden");
      loadData();
    } else alert("Login failed: "+data.message);
  });
}

// ===== LOAD DATA =====
function loadData(){
  Promise.all([post("getMembers"), post("getContributions"), post("getLoans")])
  .then(([m,c,l])=>{
    members=m.slice(1); contributions=c.slice(1); loans=l.slice(1);
    renderDashboard(); renderCharts(); renderMemberSelect();
    populateAdminSelects();
  });
}

function post(action){ return fetch(API+"?action="+action,{method:"POST", body:JSON.stringify({})}).then(r=>r.json()); }

// ===== DASHBOARD =====
function renderDashboard(){
  const visibleMembers=currentUserRole==="admin"?members:members.filter(m=>m[2]===loggedInPhone);
  document.getElementById("totalMembers").textContent=visibleMembers.length;
  document.getElementById("totalContrib").textContent=contributions.filter(c=>currentUserRole==="admin"||visibleMembers.some(m=>m[0]==c[1])).reduce((s,c)=>s+Number(c[2]),0);
  document.getElementById("totalLoans").textContent=loans.filter(l=>currentUserRole==="admin"||visibleMembers.some(m=>m[0]==l[1])).reduce((s,l)=>s+Number(l[2]),0);
}

// ===== MEMBER SELECT =====
function renderMemberSelect(){
  const sel=document.getElementById("memberSelect");
  sel.innerHTML="";
  const visibleMembers=currentUserRole==="admin"?members:members.filter(m=>m[2]===loggedInPhone);
  visibleMembers.forEach(m=>{const opt=document.createElement("option"); opt.value=m[0]; opt.textContent=m[1]; sel.appendChild(opt);});
  sel.onchange=showStatement;
  if(sel.options.length>0) sel.selectedIndex=0;
  showStatement();
}

// ===== MEMBER STATEMENT =====
function showStatement(){
  const memberId=document.getElementById("memberSelect").value;
  if(!memberId) return;
  const member=members.find(m=>m[0]==memberId);
  const memberContrib=contributions.filter(c=>c[1]==memberId);
  const memberLoans=loans.filter(l=>l[1]==memberId);
  const totalC=memberContrib.reduce((s,c)=>s+Number(c[2]),0);
  const totalL=memberLoans.reduce((s,l)=>s+Number(l[2]),0);
  document.getElementById("statement").textContent=JSON.stringify({member:member[1],phone:member[2],contributions:memberContrib,totalContributions:totalC,loans:memberLoans,totalLoans:totalL},null,2);
}

// ===== PDF DOWNLOAD =====
function downloadPDF(){
  const memberId=document.getElementById("memberSelect").value;
  if(!memberId){alert("Select a member"); return;}
  window.open(API+"?action=memberStatement&memberId="+memberId,"_blank");
}

// ===== CHARTS =====
function renderCharts(){
  const labels=members.map(m=>m[1]);
  const contribData=members.map(m=>contributions.filter(c=>c[1]==m[0]).reduce((s,c)=>s+Number(c[2]),0));
  const loanData=members.map(m=>loans.filter(l=>l[1]==m[0]).reduce((s,l)=>s+Number(l[2]),0));
  new Chart(document.getElementById("contribChart"),{type:"bar", data:{labels,datasets:[{label:"Contributions",data:contribData,backgroundColor:"#3b82f6"}]}});
  new Chart(document.getElementById("loanChart"),{type:"pie", data:{labels,datasets:[{label:"Loans",data:loanData,backgroundColor:["#ef4444","#facc15","#10b981","#3b82f6"]}]}});
}

// ===== ADMIN ACTIONS =====
function populateAdminSelects(){
  if(currentUserRole!=="admin") return;
  const contribSel=document.getElementById("contribMemberSelect");
  const loanSel=document.getElementById("loanMemberSelect");
  contribSel.innerHTML=""; loanSel.innerHTML="";
  members.forEach(m=>{
    const opt1=document.createElement("option"); opt1.value=m[0]; opt1.textContent=m[1]; contribSel.appendChild(opt1);
    const opt2=document.createElement("option"); opt2.value=m[0]; opt2.textContent=m[1]; loanSel.appendChild(opt2);
  });
}

function addMember(){
  const name=document.getElementById("newMemberName").value;
  const phone=document.getElementById("newMemberPhone").value;
  if(!name||!phone){alert("Enter name and phone"); return;}
  fetch(API+"?action=addMember",{method:"POST",body:JSON.stringify({name,phone})}).then(r=>r.json()).then(data=>{if(data.success){alert("Member added"); loadData();}});
}

function addContribution(){
  const memberId=document.getElementById("contribMemberSelect").value;
  const amount=Number(document.getElementById("contribAmount").value);
  if(!memberId||!amount){alert("Select member & enter amount"); return;}
  fetch(API+"?action=addContribution",{method:"POST",body:JSON.stringify({memberId,amount})}).then(r=>r.json()).then(data=>{if(data.success){alert("Contribution added"); loadData();}});
}

function addLoan(){
  const memberId=document.getElementById("loanMemberSelect").value;
  const amount=Number(document.getElementById("loanAmount").value);
  if(!memberId||!amount){alert("Select member & enter amount"); return;}
  fetch(API+"?action=addLoan",{method:"POST",body:JSON.stringify({memberId,amount})}).then(r=>r.json()).then(data=>{if(data.success){alert("Loan added"); loadData();}});
}
</script>

</body>
</html>
