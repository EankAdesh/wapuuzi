<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chama Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-100 p-4">

<div class="max-w-7xl mx-auto space-y-6">

  <h1 class="text-3xl font-bold">Chama Management System</h1>

  <!-- STATS -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="bg-white p-4 rounded shadow">
      <p class="text-gray-500">Members</p>
      <p id="totalMembers" class="text-2xl font-bold">0</p>
    </div>
    <div class="bg-white p-4 rounded shadow">
      <p class="text-gray-500">Total Contributions</p>
      <p id="totalContrib" class="text-2xl font-bold">0</p>
    </div>
    <div class="bg-white p-4 rounded shadow">
      <p class="text-gray-500">Total Loans</p>
      <p id="totalLoans" class="text-2xl font-bold">0</p>
    </div>
  </div>

  <!-- CHARTS -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="bg-white p-4 rounded shadow">
      <h2 class="font-semibold mb-2">Contributions per Member</h2>
      <canvas id="contribChart"></canvas>
    </div>
    <div class="bg-white p-4 rounded shadow">
      <h2 class="font-semibold mb-2">Loans per Member</h2>
      <canvas id="loanChart"></canvas>
    </div>
  </div>

  <!-- MEMBER STATEMENTS -->
  <div class="bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold mb-3">Member Statement</h2>

    <select id="memberSelect" class="border p-2 rounded mb-3 w-full md:w-1/3">
      <option value="">Select Member</option>
    </select>

    <pre id="statement" class="bg-gray-100 p-3 rounded text-sm overflow-auto"></pre>
  </div>

</div>

<script>
const API = "PASTE_API_URL_HERE";

let members = [];
let contributions = [];
let loans = [];

function post(action) {
  return fetch(API + "?action=" + action, {
    method: "POST",
    body: JSON.stringify({})
  }).then(r => r.json());
}

// LOAD ALL DATA
Promise.all([
  post("getMembers"),
  post("getContributions"),
  post("getLoans")
]).then(([m, c, l]) => {
  members = m.slice(1);
  contributions = c.slice(1);
  loans = l.slice(1);

  totalMembers.textContent = members.length;
  loadTotals();
  populateMembers();
  drawCharts();
});

// TOTALS
function loadTotals() {
  let contribSum = 0;
  let loanSum = 0;

  contributions.forEach(r => contribSum += Number(r[2]));
  loans.forEach(r => loanSum += Number(r[2]));

  totalContrib.textContent = contribSum;
  totalLoans.textContent = loanSum;
}

// POPULATE DROPDOWN
function populateMembers() {
  members.forEach(m => {
    const opt = document.createElement("option");
    opt.value = m[0];
    opt.textContent = m[1];
    memberSelect.appendChild(opt);
  });

  memberSelect.onchange = showStatement;
}

// MEMBER STATEMENT
function showStatement() {
  const memberId = memberSelect.value;
  if (!memberId) return;

  const member = members.find(m => m[0] == memberId);
  const memberContrib = contributions.filter(c => c[1] == memberId);
  const memberLoans = loans.filter(l => l[1] == memberId);

  let contribTotal = 0;
  memberContrib.forEach(c => contribTotal += Number(c[2]));

  let loanTotal = 0;
  memberLoans.forEach(l => loanTotal += Number(l[2]));

  statement.textContent = JSON.stringify({
    member: member[1],
    phone: member[2],
    contributions: memberContrib,
    totalContributions: contribTotal,
    loans: memberLoans,
    totalLoans: loanTotal
  }, null, 2);
}

// CHARTS
function drawCharts() {
  const labels = members.map(m => m[1]);

  const contribData = members.map(m =>
    contributions
      .filter(c => c[1] == m[0])
      .reduce((s, c) => s + Number(c[2]), 0)
  );

  const loanData = members.map(m =>
    loans
      .filter(l => l[1] == m[0])
      .reduce((s, l) => s + Number(l[2]), 0)
  );

  new Chart(document.getElementById("contribChart"), {
    type: "bar",
    data: {
      labels,
      datasets: [{ label: "Contributions", data: contribData }]
    }
  });

  new Chart(document.getElementById("loanChart"), {
    type: "pie",
    data: {
      labels,
      datasets: [{ label: "Loans", data: loanData }]
    }
  });
}
</script>

</body>
</html>
